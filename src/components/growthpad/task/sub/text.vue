<script setup lang="ts">
import { computed, defineProps, reactive, ref, toRaw, defineEmit } from 'vue'
import { addressEnum, getValueStatus } from './value'
// @ts-ignore
import rules from './rule'
import { checkAddress } from '~/components/growthpad/task/task'
import { MissionStatus } from '~/store/growthpad/props'
import I18n from '~/utils/i18n/index'
import Task from '~/logic/growthpad/task'
import activity from '~/logic/growthpad/activity'
import Message from '~/utils/message'
import TaskType from '~/logic/growthpad/tasktype'

const emitEvent = defineEmit(['updated'])

const props = defineProps({
  // 判断地址名称
  name: {
    type: String,
  },
  // 输入框提示信息
  placeholder: {
    type: String,
  },
  data: {
    type: Object,
  },
  confirm: {
    type: Boolean,
    default: () => {
      return false
    },
  },
})

const store = Task()

const editStatus = ref<boolean>(false)

const _loadingStatus = function(): MissionStatus {
  const status: MissionStatus = getValueStatus(props.name, store, props.data)
  if (status) {
    return status
  }
  // 默认为空
  return MissionStatus.init
}

// @ts-ignore
const loadingStatus = computed<MissionStatus>(_loadingStatus)

// 输入框提示语
const InputPlaceholder = computed<string>(function() {
  if (_loadingStatus() === MissionStatus.fail) {
    return I18n.common.message.fail
  }
  return props.placeholder
})
// 是否显示前缀
const prefixStatus = computed<boo>(function() {
  switch (props.name) {
    case TaskType.telegram:
    case TaskType.twitter:
    case TaskType.retwitter:
      return true
    default:
      return false
  }
})

const formRef = ref<any>(null)
const formdata = reactive({
  input: '',
})

// @ts-ignore
const onSubmit = async function() {
  // 判断活动时间
  let status = activity(store)
  if (!status) {
    return false
  }
  const form = toRaw(formRef).value
  const value = formdata.input
  try {
    // 表单校验
    await form.validate()
    // 判断信息登记
    status = checkAddress(store)


    // 在活动时间范围内判断是否需要二次确认
    if (status && props.confirm) {
      // 输入内容确认
      status = await Message(I18n.growthpad.form.address, {
        value,
        warn: I18n.growthpad.form.warning,
      })
    }
    if (status) {
      // @ts-ignore
      const name = addressEnum[props.name]
      // @ts-ignore
      if (name && store[name]) {
        // @ts-ignore
        await store[name](value)
        editStatus.value = true
        // 清空表单
        form.resetFields()
        // 清除验证结果
        form.clearValidate()
        // 数据更新成功后执行
        emitEvent('updated', props.name)
      }
    }
  } catch (e) {
    console.log(e)
    // todo
  }
}
</script>

<template>
  <IconFont v-if="loadingStatus === MissionStatus.success" type="success"/>
  <span class="suspend inline-block" v-else-if="loadingStatus === MissionStatus.suspend">{{ I18n.growthpad.status.suspend }}</span>
  <Loading v-else-if="loadingStatus === MissionStatus.loading" :value="I18n.common.message.checking24h"/>
  <el-form
    v-else
    ref="formRef"
    class="check-box md:w-56"
    label-width="0px"
    :show-message="false"
    :model="formdata"
    :rules="rules"
    @submit.stop.prevent="onSubmit"
  >
    <el-form-item prop="input">
      <el-input type="text" v-model="formdata.input" :placeholder="InputPlaceholder" autocomplete="off" size="small" :class="{ fail: loadingStatus === MissionStatus.fail }">
        <template v-if="prefixStatus" #prefix>
          <span class="pl-1">@</span>
        </template>
      </el-input>
    </el-form-item>
    <div class="suffix" @click="onSubmit">
      <slot></slot>
    </div>
  </el-form>
</template>

<style scoped lang="scss">
@import './input.scss';


.suspend {
  padding: 2px 12px;
  background: rgba(37, 62, 111, 0.1);
  border-radius: 12px;
  font-size: 12px;
  font-weight: 500;
  color: rgba(37, 62, 111, 0.35);
}

</style>
